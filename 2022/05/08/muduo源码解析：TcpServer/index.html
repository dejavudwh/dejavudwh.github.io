<!DOCTYPE html>
<html lang="zh">
    <head>
    <meta charset="utf-8">

    

    <!-- æ¸²æŸ“ä¼˜åŒ– -->
    <meta name="renderer" content="webkit">
    <meta name="force-rendering" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="HandheldFriendly" content="True" >
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <!--icon-->

    
        <link rel="shortcut icon" href="/favicon.ico">
    
    
    
    
    


    <!-- meta -->


<title>muduoæºç è§£æï¼šTcpServer | dejavudwh&#39;s blog</title>


    <meta name="keywords" content="muduo, æºç è§£æ">




    <!-- OpenGraph -->
 
    <meta name="description" content="ç»§ä¸Šç¯‡åˆ†æå®ŒChannelã€Acceptorã€EPollPollerå’Œéƒ¨åˆ†EventLoopä¹‹åï¼Œå·²ç»èƒ½å¤Ÿå¤§è‡´ç†è§£äº†æ•´ä¸ªmuduoçš„æµç¨‹ã€‚ å›é¡¾ä¸Šç¯‡æœ€åæåˆ°çš„é—®é¢˜ï¼šè°æ¥è´Ÿè´£åˆ›å»ºå’Œä¼ é€’Channelï¼ŸTcpConnectionã€‚ TcpConnectionTcpConnectionè´Ÿè´£ç®¡ç†ä¸€ä¸ªTCPè¿æ¥å’Œè¿™ä¸ªè¿æ¥çš„è¾“å…¥è¾“å‡ºç¼“å†²åŒºï¼Œç”±Acceptoræ¥æ”¶åˆ°ä¸€ä¸ªæ–°è¿æ¥æ—¶åˆ›å»ºï¼Œä¹Ÿå°±æ˜¯ä¸ŠèŠ‚è®²åˆ°çš„Accept">
<meta property="og:type" content="article">
<meta property="og:title" content="muduoæºç è§£æï¼šTcpServer">
<meta property="og:url" content="http://dejavudwh.cn/2022/05/08/muduo%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%9ATcpServer/index.html">
<meta property="og:site_name" content="dejavudwh&#39;s blog">
<meta property="og:description" content="ç»§ä¸Šç¯‡åˆ†æå®ŒChannelã€Acceptorã€EPollPollerå’Œéƒ¨åˆ†EventLoopä¹‹åï¼Œå·²ç»èƒ½å¤Ÿå¤§è‡´ç†è§£äº†æ•´ä¸ªmuduoçš„æµç¨‹ã€‚ å›é¡¾ä¸Šç¯‡æœ€åæåˆ°çš„é—®é¢˜ï¼šè°æ¥è´Ÿè´£åˆ›å»ºå’Œä¼ é€’Channelï¼ŸTcpConnectionã€‚ TcpConnectionTcpConnectionè´Ÿè´£ç®¡ç†ä¸€ä¸ªTCPè¿æ¥å’Œè¿™ä¸ªè¿æ¥çš„è¾“å…¥è¾“å‡ºç¼“å†²åŒºï¼Œç”±Acceptoræ¥æ”¶åˆ°ä¸€ä¸ªæ–°è¿æ¥æ—¶åˆ›å»ºï¼Œä¹Ÿå°±æ˜¯ä¸ŠèŠ‚è®²åˆ°çš„Accept">
<meta property="og:locale">
<meta property="og:image" content="https://raw.githubusercontent.com/dejavudwh/dejavudwh.github.io/picbed/muduo/20220508145101.png">
<meta property="article:published_time" content="2022-05-08T04:13:05.000Z">
<meta property="article:modified_time" content="2022-05-08T07:54:25.250Z">
<meta property="article:author" content="dejavudwh">
<meta property="article:tag" content="muduo">
<meta property="article:tag" content="æºç è§£æ">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://raw.githubusercontent.com/dejavudwh/dejavudwh.github.io/picbed/muduo/20220508145101.png">


    
<link rel="stylesheet" href="/css/style/main.css">
 

    
    
        <link rel="stylesheet" id="hl-default-theme" href="/css/highlight/default.css" media="none" >
        
            <link rel="stylesheet" id="hl-dark-theme" href="/css/highlight/dark.css" media="none">
        
    

    
    

    
    
<link rel="stylesheet" href="/css/style/dark.css">

    
<script src="/js/darkmode.js"></script>



     

    <!-- custom head -->

<meta name="generator" content="Hexo 6.1.0"></head>

    <body>
        <div id="app">
            <header class="header">
    <div class="header__left">
        <a href="/" class="button">
            <span class="logo__text">dejavudwh</span>
        </a>
    </div>
    <div class="header__right">
        
            <div class="navbar__menus">
                
                    <a href="/" class="navbar-menu button">Home</a>
                
                    <a href="/archives/" class="navbar-menu button">archives</a>
                
                    <a href="/categories/" class="navbar-menu button">categories</a>
                
                    <a href="/tags/" class="navbar-menu button">tags</a>
                
                    <a href="/about/" class="navbar-menu button">about</a>
                
            </div>
        
        
        
    <a href="/search/" id="btn-search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" width="24" height="24" fill="currentColor" stroke="currentColor" stroke-width="32"><path d="M192 448c0-141.152 114.848-256 256-256s256 114.848 256 256-114.848 256-256 256-256-114.848-256-256z m710.624 409.376l-206.88-206.88A318.784 318.784 0 0 0 768 448c0-176.736-143.264-320-320-320S128 271.264 128 448s143.264 320 320 320a318.784 318.784 0 0 0 202.496-72.256l206.88 206.88 45.248-45.248z"></path></svg>
    </a>


        
        
    <a href="javaScript:void(0);" id="btn-toggle-dark">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
    </a>


        
            <a class="dropdown-icon button" id="btn-dropdown" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width='24' height='24' fill="none" stroke="currentColor" stroke-width="0.7" stroke-linecap="round" stroke-linejoin="round"><path fill="currentColor" d="M3.314,4.8h13.372c0.41,0,0.743-0.333,0.743-0.743c0-0.41-0.333-0.743-0.743-0.743H3.314c-0.41,0-0.743,0.333-0.743,0.743C2.571,4.467,2.904,4.8,3.314,4.8z M16.686,15.2H3.314c-0.41,0-0.743,0.333-0.743,0.743s0.333,0.743,0.743,0.743h13.372c0.41,0,0.743-0.333,0.743-0.743S17.096,15.2,16.686,15.2z M16.686,9.257H3.314c-0.41,0-0.743,0.333-0.743,0.743s0.333,0.743,0.743,0.743h13.372c0.41,0,0.743-0.333,0.743-0.743S17.096,9.257,16.686,9.257z"></path></svg></a>
            <div class="dropdown-menus" id="dropdown-menus">
                
                    <a href="/" class="dropdown-menu button">Home</a>
                
                    <a href="/archives/" class="dropdown-menu button">archives</a>
                
                    <a href="/categories/" class="dropdown-menu button">categories</a>
                
                    <a href="/tags/" class="dropdown-menu button">tags</a>
                
                    <a href="/about/" class="dropdown-menu button">about</a>
                
            </div>
        
    </div>
</header>


            <main class="main">
    

<div class="post-title">
    <h1 class="post-title__text">
        muduoæºç è§£æï¼šTcpServer
    </h1>
    <div class="post-title__meta">
        <a href="/archives/2022/05/" class="post-meta__date button">2022-05-08</a>
        
    <span class="separate-dot"></span><a href="/categories/muduo%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" class="button">muduoæºç è§£æ</a>

 
        
    
    


 

 
    </div>
</div>


    <aside class="post-side">
        <div class="post-side__toc">
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">TcpConnection</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.1.</span> <span class="toc-text">sendInLoop</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">TcpServer</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">2.1.</span> <span class="toc-text">newConnection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">2.2.</span> <span class="toc-text">connectEstablished</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">Buffer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">4.</span> <span class="toc-text">æ€»ç»“</span></a></li></ol>
        </div>
    </aside>
    <a class="btn-toc button" id="btn-toc" tabindex="0">
        <svg viewBox="0 0 1024 1024" width="32" height="32" xmlns="http://www.w3.org/2000/svg">
            <path d="M128 256h64V192H128zM320 256h576V192H320zM128 544h64v-64H128zM320 544h576v-64H320zM128 832h64v-64H128zM320 832h576v-64H320z" fill="currentColor"></path>
        </svg>
    </a>
    <div class="toc-menus" id="toc-menus">
        <div class="toc-title">Article Directory</div>
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">TcpConnection</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.1.</span> <span class="toc-text">sendInLoop</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">TcpServer</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">2.1.</span> <span class="toc-text">newConnection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">2.2.</span> <span class="toc-text">connectEstablished</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">Buffer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">4.</span> <span class="toc-text">æ€»ç»“</span></a></li></ol>
    </div>


<article class="post post__with-toc content-card">
    <div class="post__header"></div>
    <div class="post__content">
        <p>ç»§ä¸Šç¯‡åˆ†æå®ŒChannelã€Acceptorã€EPollPollerå’Œéƒ¨åˆ†EventLoopä¹‹åï¼Œå·²ç»èƒ½å¤Ÿå¤§è‡´ç†è§£äº†æ•´ä¸ªmuduoçš„æµç¨‹ã€‚</p>
<p>å›é¡¾ä¸Šç¯‡æœ€åæåˆ°çš„é—®é¢˜ï¼šè°æ¥è´Ÿè´£åˆ›å»ºå’Œä¼ é€’Channelï¼ŸTcpConnectionã€‚</p>
<h2><span id="tcpconnection">TcpConnection</span></h2><p>TcpConnectionè´Ÿè´£ç®¡ç†ä¸€ä¸ªTCPè¿æ¥å’Œè¿™ä¸ªè¿æ¥çš„è¾“å…¥è¾“å‡ºç¼“å†²åŒºï¼Œç”±Acceptoræ¥æ”¶åˆ°ä¸€ä¸ªæ–°è¿æ¥æ—¶åˆ›å»ºï¼Œä¹Ÿå°±æ˜¯ä¸ŠèŠ‚è®²åˆ°çš„<code>Acceptor::handleRead</code>ä¸­çš„å›è°ƒæ‰€åˆ›å»ºçš„ï¼Œä¸‹é¢ä¼šè¯¦ç»†è§£æã€‚</p>
<p>å…ˆæ¥çœ‹å®ƒçš„éƒ¨åˆ†æ¥å£å®šä¹‰ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TcpConnection</span> : boost::noncopyable,</span><br><span class="line">                      <span class="keyword">public</span> boost::enable_shared_from_this&lt;TcpConnection&gt;</span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">TcpConnection</span>(EventLoop* loop,</span><br><span class="line">                <span class="type">const</span> string&amp; name,</span><br><span class="line">                <span class="type">int</span> sockfd,</span><br><span class="line">                <span class="type">const</span> InetAddress&amp; localAddr,</span><br><span class="line">                <span class="type">const</span> InetAddress&amp; peerAddr);</span><br><span class="line">  ~<span class="built_in">TcpConnection</span>();</span><br><span class="line"></span><br><span class="line">  <span class="function">EventLoop* <span class="title">getLoop</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> loop_; &#125;</span><br><span class="line">  <span class="function"><span class="type">const</span> string&amp; <span class="title">name</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> name_; &#125;</span><br><span class="line">  <span class="function"><span class="type">const</span> InetAddress&amp; <span class="title">localAddress</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> localAddr_; &#125;</span><br><span class="line">  <span class="function"><span class="type">const</span> InetAddress&amp; <span class="title">peerAddress</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> peerAddr_; &#125;</span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">connected</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> state_ == kConnected; &#125;</span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">disconnected</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> state_ == kDisconnected; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">send</span><span class="params">(<span class="type">const</span> <span class="type">void</span>* message, <span class="type">int</span> len)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">send</span><span class="params">(Buffer* message)</span></span>;  <span class="comment">// this one will swap data</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">shutdown</span><span class="params">()</span></span>; <span class="comment">// NOT thread safe, no simultaneous calling</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">connectEstablished</span><span class="params">()</span></span>;   <span class="comment">// should be called only once</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">connectDestroyed</span><span class="params">()</span></span>;  <span class="comment">// should be called only once</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">enum</span> <span class="title class_">StateE</span> &#123; kDisconnected, kConnecting, kConnected, kDisconnecting &#125;;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">handleRead</span><span class="params">(Timestamp receiveTime)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">handleWrite</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">handleClose</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">handleError</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="comment">// void sendInLoop(string&amp;&amp; message);</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">sendInLoop</span><span class="params">(<span class="type">const</span> StringPiece&amp; message)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">sendInLoop</span><span class="params">(<span class="type">const</span> <span class="type">void</span>* message, <span class="type">size_t</span> len)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">shutdownInLoop</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  EventLoop* loop_;</span><br><span class="line">  <span class="type">const</span> string name_;  <span class="comment">// è¿æ¥åç§°</span></span><br><span class="line">  StateE state_;  <span class="comment">// <span class="doctag">FIXME:</span> use atomic variable  </span></span><br><span class="line">  <span class="type">bool</span> reading_;</span><br><span class="line">  <span class="comment">// we don&#x27;t expose those classes to client.</span></span><br><span class="line">  boost::scoped_ptr&lt;Socket&gt; socket_;</span><br><span class="line">  boost::scoped_ptr&lt;Channel&gt; channel_;</span><br><span class="line">  <span class="type">const</span> InetAddress localAddr_;   </span><br><span class="line">  <span class="type">const</span> InetAddress peerAddr_;	  </span><br><span class="line">  </span><br><span class="line">  ConnectionCallback connectionCallback_;</span><br><span class="line">  MessageCallback messageCallback_;</span><br><span class="line">  WriteCompleteCallback writeCompleteCallback_;     <span class="comment">// æ•°æ®å‘é€å®Œæ¯•å›è°ƒå‡½æ•°ï¼Œå³æ‰€æœ‰çš„ç”¨æˆ·æ•°æ®éƒ½å·²æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºæ—¶å›è°ƒè¯¥å‡½æ•°</span></span><br><span class="line">									</span><br><span class="line">  HighWaterMarkCallback highWaterMarkCallback_;    <span class="comment">// é«˜æ°´ä½æ ‡å›è°ƒå‡½æ•°,ä¹Ÿå°±æ˜¯outputBufferæ’‘åˆ°ä¸€å®šç¨‹åº¦äº†</span></span><br><span class="line">  CloseCallback closeCallback_;</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> highWaterMark_;	<span class="comment">// é«˜æ°´ä½æ ‡</span></span><br><span class="line">  Buffer inputBuffer_;		<span class="comment">// æ¥æ”¶ç¼“å†²åŒº</span></span><br><span class="line">  Buffer outputBuffer_; <span class="comment">// <span class="doctag">FIXME:</span> use list&lt;Buffer&gt; as output buffer.</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­TcpConnectionä¸­çš„callbackéƒ½æ˜¯ç”±ç”¨æˆ·è®¾ç½®ï¼ˆTcpServerä¸ºä¸€ä¸ªé—´æ¥å±‚ï¼Œåé¢å†æï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ç”¨æˆ·è¦å¤„ç†çš„ä¸‰ä¸ªåŠäº‹ä»¶éƒ½æ˜¯ç”±TcpConnectionè¿›è¡Œç®¡ç†ï¼Œå½“ç„¶TcpConnectionè¿˜æŒæœ‰ä¸€ä¸ªChannelï¼Œä¹Ÿå°±æ˜¯æœ€åè¿˜æ˜¯ç”±TcpConnectionååº”åˆ°Channelä¸­ï¼ˆåœ¨æ„é€ å‡½æ•°ä¸­è®¾ç½®ï¼‰ã€‚</p>
<p>å½“ç„¶è¿™äº›callbackè¿˜éœ€è¦TcpConnectionå†è¿›è¡Œä¸€å±‚wrapï¼Œå› ä¸ºç”¨æˆ·åªå…³å¿ƒé€»è¾‘çš„å¤„ç†ï¼Œæ‰€ä»¥è¿˜æ˜¯æœ‰ä¸€äº›å·¥ä½œéœ€è¦TcpConnectionæ¥å®Œæˆã€‚TcpConnectionå¯¹è¿™äº›callbackçš„wrapå°±æ˜¯åœ¨<code>handleRead</code>ã€<code>handleWrite</code>ç­‰ä¸­ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">TcpConnection::handleWrite</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  loop_-&gt;<span class="built_in">assertInLoopThread</span>();</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// å¦‚æœæ­£å¤„äºå…³æ³¨POLLOUTäº‹ä»¶,è¯´æ˜ä¹‹å‰çš„æ•°æ®æ²¡æœ‰å‘é€å®Œæˆï¼Œåˆ™å°†ç¼“å†²åŒºçš„æ•°æ®å‘é€</span></span><br><span class="line">  <span class="keyword">if</span> (channel_-&gt;<span class="built_in">isWriting</span>())   </span><br><span class="line">  &#123;</span><br><span class="line">    <span class="type">ssize_t</span> n = sockets::<span class="built_in">write</span>(channel_-&gt;<span class="built_in">fd</span>(),</span><br><span class="line">                               outputBuffer_.<span class="built_in">peek</span>(),</span><br><span class="line">                               outputBuffer_.<span class="built_in">readableBytes</span>());</span><br><span class="line">    <span class="keyword">if</span> (n &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      outputBuffer_.<span class="built_in">retrieve</span>(n);  <span class="comment">// å°†readindex_æŒ‡é’ˆå›æ”¶</span></span><br><span class="line">      <span class="keyword">if</span> (outputBuffer_.<span class="built_in">readableBytes</span>() == <span class="number">0</span>)  <span class="comment">//è¯´æ˜å·²ç»å‘é€å®Œæ¯•äº†ï¼Œç¼“å†²åŒºå·²æ¸…ç©º</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">//åœæ­¢å…³æ³¨POLLOUTäº‹ä»¶ï¼Œä»¥å…å‡ºç°busy-loop</span></span><br><span class="line">        channel_-&gt;<span class="built_in">disableWriting</span>();</span><br><span class="line">        <span class="keyword">if</span> (writeCompleteCallback_)  <span class="comment">//å›è°ƒwriteCompleteCallback</span></span><br><span class="line">        &#123;</span><br><span class="line">			<span class="comment">// åº”ç”¨å±‚å‘é€ç¼“å†²åŒºè¢«æ¸…ç©ºï¼Œå°±å›è°ƒç”¨writeCompleteCallback_</span></span><br><span class="line">          loop_-&gt;<span class="built_in">queueInLoop</span>(boost::<span class="built_in">bind</span>(writeCompleteCallback_, <span class="built_in">shared_from_this</span>()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (state_ == kDisconnecting)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">shutdownInLoop</span>();  <span class="comment">// å‘é€ç¼“å†²åŒºå·²æ¸…ç©ºå¹¶ä¸”è¿æ¥çŠ¶æ€æ˜¯kDisconnecting, è¦å…³é—­è¿æ¥</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      LOG_SYSERR &lt;&lt; <span class="string">&quot;TcpConnection::handleWrite&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    LOG_TRACE &lt;&lt; <span class="string">&quot;Connection fd = &quot;</span> &lt;&lt; channel_-&gt;<span class="built_in">fd</span>()</span><br><span class="line">              &lt;&lt; <span class="string">&quot; is down, no more writing&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handleWrite</code>ã€<code>handleRead</code>ç­‰çš„é€»è¾‘éƒ½éå¸¸ç®€å•ï¼Œä¸»è¦éƒ½æ˜¯åˆ¤æ–­channelçš„çŠ¶æ€ç„¶åé€šè¿‡Bufferå¯¹fdè¿›è¡Œè¯»å†™ï¼ŒBufferæ˜¯muduoä¸­æä¾›çš„ä¸€ä¸ªç¼“å†²åŒºï¼Œè¿™ä¸ªåé¢å†è§£æã€‚æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬åªçœ‹<code>handleWrite</code>ï¼Œé¦–å…ˆåˆ¤æ–­channelæ˜¯å¦å¯è¯»ï¼Œå¦‚æœå¯è¯»åˆ™è°ƒç”¨<code>sockets::write</code>ï¼Œè¿™ä¸ªå‡½æ•°ä¹Ÿåªæ˜¯å¯¹<code>writed</code>çš„ä¸€å±‚å°è£…ï¼Œç„¶åé€šè¿‡<code>write</code>çš„è¿”å›å€¼åˆ¤æ–­Bufferæ˜¯å¦è¢«è¯»å®Œï¼Œæ¥ä»¥æ­¤å†³å®šè¦ä¸è¦å›è°ƒ<code>writeCompleteCallback</code>ä»¥åŠå…³é—­è¿æ¥ã€‚</p>
<h3><span id="sendinloop">sendInLoop</span></h3><p>å½“ç„¶ï¼ŒTcpConnectioné™¤äº†å°è£…äº†<code>handleWrite</code>ç­‰ï¼Œè¿˜å‘ç”¨æˆ·æä¾›<code>send</code>æ¥å£ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">TcpConnection::send</span><span class="params">(<span class="type">const</span> StringPiece&amp; message)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (state_ == kConnected)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (loop_-&gt;<span class="built_in">isInLoopThread</span>())   <span class="comment">// å½“å‰çº¿ç¨‹å°±æ˜¯IOçº¿ç¨‹ï¼Œç›´æ¥è°ƒç”¨</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">sendInLoop</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      loop_-&gt;<span class="built_in">runInLoop</span>(</span><br><span class="line">          boost::<span class="built_in">bind</span>(&amp;TcpConnection::sendInLoop,</span><br><span class="line">                      <span class="keyword">this</span>,     <span class="comment">// FIXME</span></span><br><span class="line">                      message.<span class="built_in">as_string</span>()));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TcpConnection::sendInLoop</span><span class="params">(<span class="type">const</span> <span class="type">void</span>* data, <span class="type">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  loop_-&gt;<span class="built_in">assertInLoopThread</span>();</span><br><span class="line">  <span class="type">ssize_t</span> nwrote = <span class="number">0</span>;</span><br><span class="line">  <span class="type">size_t</span> remaining = len;    <span class="comment">// å‰©ä½™çš„å¾…å‘é€å­—èŠ‚æ•°</span></span><br><span class="line">  <span class="type">bool</span> faultError = <span class="literal">false</span>;   <span class="comment">// æ˜¯å¦é”™è¯¯</span></span><br><span class="line">  <span class="keyword">if</span> (state_ == kDisconnected)</span><br><span class="line">  &#123;</span><br><span class="line">    LOG_WARN &lt;&lt; <span class="string">&quot;disconnected, give up writing&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// if no thing in output queue, try writing directly</span></span><br><span class="line">  <span class="comment">// é€šé“æ²¡æœ‰å…³æ³¨å¯å†™äº‹ä»¶å¹¶ä¸”å‘é€ç¼“å†²åŒºæ²¡æœ‰æ•°æ®ï¼Œç›´æ¥write</span></span><br><span class="line">  <span class="keyword">if</span> (!channel_-&gt;<span class="built_in">isWriting</span>() &amp;&amp; outputBuffer_.<span class="built_in">readableBytes</span>() == <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    nwrote = sockets::<span class="built_in">write</span>(channel_-&gt;<span class="built_in">fd</span>(), data, len);</span><br><span class="line">    <span class="keyword">if</span> (nwrote &gt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      remaining = len - nwrote;</span><br><span class="line">	  <span class="comment">// å†™å®Œäº†ï¼Œå›è°ƒwriteCompleteCallback_</span></span><br><span class="line">      <span class="keyword">if</span> (remaining == <span class="number">0</span> &amp;&amp; writeCompleteCallback_)</span><br><span class="line">      &#123;</span><br><span class="line">        loop_-&gt;<span class="built_in">queueInLoop</span>(boost::<span class="built_in">bind</span>(writeCompleteCallback_, <span class="built_in">shared_from_this</span>()));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">// nwrote &lt; 0</span></span><br><span class="line">    &#123;</span><br><span class="line">      nwrote = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> (errno != EWOULDBLOCK)</span><br><span class="line">      &#123;</span><br><span class="line">        LOG_SYSERR &lt;&lt; <span class="string">&quot;TcpConnection::sendInLoop&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (errno == EPIPE || errno == ECONNRESET) <span class="comment">// <span class="doctag">FIXME:</span> any others?</span></span><br><span class="line">        &#123;</span><br><span class="line">          faultError = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">assert</span>(remaining &lt;= len);</span><br><span class="line">  <span class="comment">// æ²¡æœ‰é”™è¯¯ï¼Œå¹¶ä¸”è¿˜æœ‰æœªå†™å®Œçš„æ•°æ®ï¼ˆè¯´æ˜å†…æ ¸å‘é€ç¼“å†²åŒºæ»¡ï¼Œè¦å°†æœªå†™å®Œçš„æ•°æ®æ·»åŠ åˆ°output bufferä¸­ï¼‰</span></span><br><span class="line">  <span class="keyword">if</span> (!faultError &amp;&amp; remaining &gt; <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="type">size_t</span> oldLen = outputBuffer_.<span class="built_in">readableBytes</span>();  <span class="comment">//outbufä¸­æœ¬èº«æœ‰çš„æ•°æ®é‡</span></span><br><span class="line">	<span class="comment">// å¦‚æœè¶…è¿‡highWaterMark_ï¼ˆé«˜æ°´ä½æ ‡ï¼‰ï¼Œå›è°ƒhighWaterMarkCallback_</span></span><br><span class="line">    <span class="keyword">if</span> (oldLen + remaining &gt;= highWaterMark_</span><br><span class="line">        &amp;&amp; oldLen &lt; highWaterMark_</span><br><span class="line">        &amp;&amp; highWaterMarkCallback_)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">//sendInLoopä¹Ÿæ˜¯åœ¨ioçº¿ç¨‹ä¸­æ‰§è¡Œï¼Œä¸ç›´æ¥è°ƒç”¨å›è°ƒå‡½æ•°ï¼Œè€Œæ˜¯è°ƒç”¨queueInLoop</span></span><br><span class="line">      loop_-&gt;<span class="built_in">queueInLoop</span>(boost::<span class="built_in">bind</span>(highWaterMarkCallback_, <span class="built_in">shared_from_this</span>(), oldLen + remaining));</span><br><span class="line">    &#125;</span><br><span class="line">    outputBuffer_.<span class="built_in">append</span>(<span class="built_in">static_cast</span>&lt;<span class="type">const</span> <span class="type">char</span>*&gt;(data)+nwrote, remaining);</span><br><span class="line">    <span class="keyword">if</span> (!channel_-&gt;<span class="built_in">isWriting</span>())    <span class="comment">//å¦‚æœæ²¡æœ‰å…³æ³¨POLLOUTäº‹ä»¶ï¼Œåˆ™è¿›è¡Œå…³æ³¨polloutäº‹ä»¶</span></span><br><span class="line">    &#123;</span><br><span class="line">      channel_-&gt;<span class="built_in">enableWriting</span>();  </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæ¶‰åŠäº†muduoä¸­å’ŒEventLoopæœ‰å…³çš„éå¸¸é‡è¦çš„è®¾è®¡ã€‚</p>
<p>é¦–å…ˆï¼Œè¿™é‡Œåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š</p>
<ul>
<li>åœ¨å¯¹åº”çš„EventLoopçº¿ç¨‹ä¸­</li>
</ul>
<p>å¦‚æœåœ¨å¯¹åº”çš„çº¿ç¨‹å½“ä¸­ï¼Œç›´æ¥è°ƒç”¨<code>sendInLoop</code>è¿›è¡Œå‘é€ï¼Œä¸»è¦é€»è¾‘å’Œ<code>handleWrite</code>æœ‰ç‚¹ç±»ä¼¼ï¼Œä¹Ÿæ˜¯æ ¹æ®channelå’Œbufferçš„ä¸ç”¨çŠ¶æ€æ¥èµ°å‘ä¸åŒçš„åˆ†æ”¯ï¼Œè¿™é‡Œä¸åŒçš„æ˜¯ï¼Œå¦‚æœè¿˜æœ‰æœªå†™å®Œçš„æ•°æ®ï¼Œéœ€è¦é‡æ–°å†™å…¥outBufferä¸­ï¼Œå¹¶ä¸”è¿˜è¦åˆ¤æ–­æ˜¯å¦éœ€è¦è°ƒç”¨<code>highWaterMarkCallback_</code>ã€‚</p>
<ul>
<li>ä¸åœ¨å¯¹åº”çš„EventLoopçº¿ç¨‹ä¸­</li>
</ul>
<p>å¦‚æœä¸åœ¨å¯¹åº”çš„çº¿ç¨‹ä¸­ï¼Œåˆ™ä¼šè°ƒç”¨EventLoopçš„<code>runInLoop</code>ï¼ŒåŠ å…¥é˜Ÿåˆ—ï¼Œç”±ä¸Šç¯‡æ²¡æœ‰è®²çš„<code>doPendingFunctors</code>è¿›è¡Œå¤„ç†ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ä»£ç ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">EventLoop::queueInLoop</span><span class="params">(<span class="type">const</span> Functor&amp; cb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  &#123;	</span><br><span class="line">  	<span class="function">MutexLockGuard <span class="title">lock</span><span class="params">(mutex_)</span></span>;</span><br><span class="line">  	pendingFunctors_.<span class="built_in">push_back</span>(cb);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å¦‚æœä¸æ˜¯å½“å‰çº¿ç¨‹(å¯èƒ½é˜»å¡åœ¨poll)ï¼Œéœ€è¦å”¤é†’ </span></span><br><span class="line">  <span class="comment">// æˆ–è€…æ˜¯å½“å‰çº¿ç¨‹ä½†æ˜¯åœ¨æ­£åœ¨å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡(ä½¿å¾—å¤„ç†å®Œå½“å‰é˜Ÿåˆ—ä¸­çš„å…ƒç´ åç«‹å³åœ¨è¿›è¡Œä¸‹ä¸€è½®å¤„ç†ï¼Œå› ä¸ºåœ¨è¿™é‡Œåˆæ·»åŠ äº†ä»»åŠ¡)éœ€è¦å”¤é†’</span></span><br><span class="line">  <span class="comment">// åªæœ‰å½“å‰IOçº¿ç¨‹çš„äº‹ä»¶å›è°ƒä¸­è°ƒç”¨queueInLoopæ‰ä¸éœ€è¦å”¤é†’(å› ä¸ºæ‰§è¡Œå®ŒhandleEventä¼šè‡ªç„¶æ‰§è¡ŒdoPendingFunctor)</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">isInLoopThread</span>() || callingPendingFunctors_)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">wakeup</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„swapä¹Ÿæ˜¯ä¸€ä¸ªå°æŠ€å·§ï¼Œæ¥å‡å°ä¸´ç•ŒåŒºçš„èŒƒå›´ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™é‡Œå¦‚æœä¸åœ¨å¯¹åº”EventLoopçš„çº¿ç¨‹å½“ä¸­ï¼Œå³ä¼šå”¤é†’å¯¹åº”çš„çº¿ç¨‹æ¥å¤„ç†ç›¸åº”çš„ä»»åŠ¡ã€‚è¿™æ ·çš„ä½œç”¨æ˜¯å½“å…¶ä»–çº¿ç¨‹éœ€è¦é€šè¿‡è¿™ä¸ªçº¿ç¨‹çš„èµ„æºæ¥æ‰§è¡Œä»»åŠ¡çš„æ—¶å€™ï¼Œå¹¶ä¸æ˜¯ç›´æ¥å†å…¶ä»–çº¿ç¨‹ä¸­è®¿é—®èµ„æºè°ƒç”¨å‡½æ•°ï¼Œè¿™æ ·å°±ä¼šé€ æˆèµ„æºçš„ç«äº‰ï¼Œéœ€è¦åŠ é”ä¿è¯ï¼Œè€Œç°åœ¨æˆ‘ä»¬è®©å½“å‰çº¿ç¨‹ä¸ºå…¶ä»–çº¿ç¨‹æä¾›ä¸€ä¸ªæ¥å£ï¼Œå…¶ä»–çº¿ç¨‹å°†è¦æ‰§è¡Œçš„ä»»åŠ¡ç”¨è¿™ä¸ªæ¥å£äº¤ç»™å½“å‰çº¿ç¨‹è¿™æ ·å½“å‰çº¿ç¨‹ç»Ÿä¸€å¤„ç†è‡ªå·±çš„èµ„æºï¼Œè€Œä¸ç”¨åŠ é”ï¼Œå”¯ä¸€éœ€è¦åŠ é”çš„åœ°æ–¹å°±æ˜¯é€šè¿‡æ¥å£æ·»åŠ ä»»åŠ¡çš„ä»»åŠ¡é˜Ÿåˆ—è¿™ä¸ªåœ°æ–¹ï¼Œå¤§å¤§å‡å°äº†é”ç²’åº¦ã€‚</p>
<p>è¿™é‡Œä¸ºä»€ä¹ˆæœ‰ç«æ€ï¼Ÿå¦‚æœæˆ‘ä»¬å…è®¸ä»»åŠ¡åœ¨å…¶å®ƒçº¿ç¨‹æ‰§è¡Œï¼Œåˆ™å®ƒå¯¹åº”çš„EventLoopå¯èƒ½æ­¤æ—¶ä¼šåŒä¸€ä¸ªChannelä¼šæœ‰æ–°äº‹ä»¶å‘é€ï¼Œåˆ™å¯¹TcpConnectionçš„è°ƒç”¨å¯èƒ½ä¼šå‘é€ç«Ÿæ€ã€‚</p>
<p>ä½†æ˜¯è¿™æ—¶å€™æˆ‘ä»¬æ³¨æ„åˆ°ï¼Œä¸ºä»€ä¹ˆ<code>sendInLoop</code>è¿˜æ˜¯ä¼šè°ƒç”¨<code>queueInLoop</code>å‘¢ï¼Ÿæ­¤æ—¶å®ƒå·²ç»æ˜¯åœ¨å¯¹åº”çš„IOçº¿ç¨‹ä¸­çš„ã€‚ğŸ‘‡</p>
<p><img src="https://raw.githubusercontent.com/dejavudwh/dejavudwh.github.io/picbed/muduo/20220508145101.png" class="lazy" data-srcset="https://raw.githubusercontent.com/dejavudwh/dejavudwh.github.io/picbed/muduo/20220508145101.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABAQMAAAAl21bKAAAABlBMVEXMzMyWlpYU2uzLAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAACklEQVQImWNgAAAAAgAB9HFkpgAAAABJRU5ErkJggg=="><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_33113661/article/details/88568032">åŸæ–‡é“¾æ¥</a></p>
<p>è¿™æ—¶å€™æˆ‘ä»¬å°±å¯ä»¥æ¥çœ‹ä¸€ä¸‹TcpServerï¼Œä¹Ÿæ˜¯muduoæš´éœ²ç»™ç”¨æˆ·æœ€é‡è¦çš„ä¸€ä¸ªç±»ã€‚</p>
<h2><span id="tcpserver">TcpServer</span></h2><p>ç»è¿‡å‰é¢çš„é“ºå«ï¼ŒTcpServerå°±å˜å¾—éå¸¸ç®€å•äº†ï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹å®ƒçš„éƒ¨åˆ†æ¥å£ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TcpServer</span> : boost::noncopyable</span><br><span class="line">&#123; </span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">enum</span> <span class="title class_">Option</span></span><br><span class="line">  &#123;</span><br><span class="line">    kNoReusePort,</span><br><span class="line">    kReusePort,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//TcpServer(EventLoop* loop, const InetAddress&amp; listenAddr);</span></span><br><span class="line">  <span class="built_in">TcpServer</span>(EventLoop* loop,</span><br><span class="line">            <span class="type">const</span> InetAddress&amp; listenAddr,</span><br><span class="line">            <span class="type">const</span> string&amp; nameArg,</span><br><span class="line">            Option option = kNoReusePort);</span><br><span class="line">  ~<span class="built_in">TcpServer</span>();  <span class="comment">// force out-line dtor, for scoped_ptr members.</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">setThreadNum</span><span class="params">(<span class="type">int</span> numThreads)</span></span>;</span><br><span class="line">  <span class="comment">/// valid after calling start()</span></span><br><span class="line">  <span class="function">boost::shared_ptr&lt;EventLoopThreadPool&gt; <span class="title">threadPool</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  </span>&#123; <span class="keyword">return</span> threadPool_; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">start</span><span class="params">()</span></span>;   <span class="comment">//å¯åŠ¨</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Set connection callback.</span></span><br><span class="line">  <span class="comment">/// Not thread safe.</span></span><br><span class="line">  <span class="comment">//è®¾ç½®è¿æ¥åˆ°æ¥æˆ–è¿æ¥å…³é—­çš„å›è°ƒå‡½æ•°</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">setConnectionCallback</span><span class="params">(<span class="type">const</span> ConnectionCallback&amp; cb)</span></span></span><br><span class="line"><span class="function">  </span>&#123; connectionCallback_ = cb; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">setMessageCallback</span><span class="params">(<span class="type">const</span> MessageCallback&amp; cb)</span></span></span><br><span class="line"><span class="function">  </span>&#123; messageCallback_ = cb; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">setWriteCompleteCallback</span><span class="params">(<span class="type">const</span> WriteCompleteCallback&amp; cb)</span></span></span><br><span class="line"><span class="function">  </span>&#123; writeCompleteCallback_ = cb; &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">newConnection</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">const</span> InetAddress&amp; peerAddr)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">removeConnection</span><span class="params">(<span class="type">const</span> TcpConnectionPtr&amp; conn)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">removeConnectionInLoop</span><span class="params">(<span class="type">const</span> TcpConnectionPtr&amp; conn)</span></span>;</span><br><span class="line">  <span class="keyword">typedef</span> std::map&lt;string, TcpConnectionPtr&gt; ConnectionMap;</span><br><span class="line"></span><br><span class="line">  EventLoop* loop_;  <span class="comment">// the acceptor loop , acceptæ‰€å±çš„evenLoop,ä¸ä¸€å®šæ˜¯è¿æ¥æ‰€å±çš„EvenLoop</span></span><br><span class="line">  <span class="type">const</span> string ipPort_;   </span><br><span class="line">  <span class="type">const</span> string name_;    </span><br><span class="line">  boost::scoped_ptr&lt;Acceptor&gt; acceptor_; <span class="comment">// avoid revealing Acceptor ç”¨æ™ºèƒ½æŒ‡é’ˆç®¡ç†ptr</span></span><br><span class="line">  boost::shared_ptr&lt;EventLoopThreadPool&gt; threadPool_;  <span class="comment">//EvenLoopçº¿ç¨‹æ± </span></span><br><span class="line">  ConnectionCallback connectionCallback_;  <span class="comment">// è¿æ¥åˆ°æ¥æ—¶å›è°ƒå‡½æ•°</span></span><br><span class="line">  MessageCallback messageCallback_;			<span class="comment">// æ¶ˆæ¯åˆ°æ¥æ—¶å›æ‰å‡½æ•°</span></span><br><span class="line">  WriteCompleteCallback writeCompleteCallback_;</span><br><span class="line">  ThreadInitCallback threadInitCallback_;   <span class="comment">// çº¿ç¨‹æ± åˆå§‹åŒ–çš„å›è°ƒå‡½æ•°</span></span><br><span class="line">  AtomicInt32 started_;   <span class="comment">// æ˜¯å¦å·²ç»å¯åŠ¨</span></span><br><span class="line">  <span class="type">int</span> nextConnId_;    <span class="comment">// ä¸‹ä¸€ä¸ªè¿æ¥id</span></span><br><span class="line">  ConnectionMap connections_;  <span class="comment">//è¿æ¥åˆ—è¡¨</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒä¸»è¦æŒæœ‰ä¸€ä¸ªAcceptorå’Œä¸€ä¸ªTcpConnectionçš„Mapï¼Œè¿˜æœ‰ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œçº¿ç¨‹æ± çš„å†…å®¹æˆ‘ä»¬æ”¾åœ¨ä¸‹ä¸€ç¯‡ã€‚æ‰€ä»¥æ ¹æ®å‰é¢çš„è®²è§£ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥çŒœåˆ°TcpServerçš„å·¥ä½œäº†ï¼Œé€šè¿‡Acceptoræ¥æ¥å—ä¸€ä¸ªæ–°è¿æ¥ï¼Œå¹¶ä¼ å…¥å›è°ƒæ¥åˆ›å»ºä¸€ä¸ªTcpConnectionå’Œå…¶å¯¹åº”çš„Channelï¼Œç„¶ååœ¨TcpServerä¸­åˆ†é…TcpConnectionåˆ°ä¸åŒçš„EventLoopä¸­ï¼ˆå¤šçº¿ç¨‹ä¸‹ï¼‰ã€‚</p>
<h3><span id="newconnection">newConnection</span></h3><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…·ä½“ä»£ç æ˜¯ä¸æ˜¯è¿™æ ·åšçš„ï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹TcpServerçš„æ„é€ å‡½æ•°å’Œå®ƒä¼ ç»™Acceptorçš„å›è°ƒï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">TcpServer::<span class="built_in">TcpServer</span>(EventLoop* loop,</span><br><span class="line">                     <span class="type">const</span> InetAddress&amp; listenAddr,</span><br><span class="line">                     <span class="type">const</span> string&amp; nameArg,</span><br><span class="line">                     Option option)</span><br><span class="line">  : <span class="built_in">loop_</span>(<span class="built_in">CHECK_NOTNULL</span>(loop)),</span><br><span class="line">    <span class="built_in">ipPort_</span>(listenAddr.<span class="built_in">toIpPort</span>()),</span><br><span class="line">    <span class="built_in">name_</span>(nameArg),</span><br><span class="line">    <span class="built_in">acceptor_</span>(<span class="keyword">new</span> <span class="built_in">Acceptor</span>(loop, listenAddr, option == kReusePort)),</span><br><span class="line">    <span class="built_in">threadPool_</span>(<span class="keyword">new</span> <span class="built_in">EventLoopThreadPool</span>(loop, name_)), <span class="comment">//åˆå§‹åŒ–çº¿ç¨‹æ± </span></span><br><span class="line">    <span class="built_in">connectionCallback_</span>(defaultConnectionCallback),</span><br><span class="line">    <span class="built_in">messageCallback_</span>(defaultMessageCallback),</span><br><span class="line">    <span class="built_in">nextConnId_</span>(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">  acceptor_-&gt;<span class="built_in">setNewConnectionCallback</span>(boost::<span class="built_in">bind</span>(&amp;TcpServer::newConnection, <span class="keyword">this</span>, _1, _2));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TcpServer::newConnection</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">const</span> InetAddress&amp; peerAddr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  loop_-&gt;<span class="built_in">assertInLoopThread</span>();</span><br><span class="line">  EventLoop* ioLoop = threadPool_-&gt;<span class="built_in">getNextLoop</span>();</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">64</span>];</span><br><span class="line">  <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span> buf, <span class="string">&quot;-%s#%d&quot;</span>, ipPort_.<span class="built_in">c_str</span>(), nextConnId_);</span><br><span class="line">  ++nextConnId_;</span><br><span class="line">  string connName = name_ + buf;   <span class="comment">//è¿æ¥åç§° : servername+ipPort#conntId</span></span><br><span class="line">  <span class="function">InetAddress <span class="title">localAddr</span><span class="params">(sockets::getLocalAddr(sockfd))</span></span>;</span><br><span class="line">  <span class="comment">// åˆ›å»ºä¸€ä¸ªè¿æ¥</span></span><br><span class="line">  <span class="function">TcpConnectionPtr <span class="title">conn</span><span class="params">(<span class="keyword">new</span> TcpConnection(ioLoop,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          connName,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          sockfd,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          localAddr,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          peerAddr))</span></span>;</span><br><span class="line">  connections_[connName] = conn;</span><br><span class="line">  <span class="comment">// ä¸‹é¢ä¸‰è¡Œéƒ½æ˜¯æ³¨å†Œç”¨æˆ·çš„å›è°ƒå‡½æ•°</span></span><br><span class="line">  conn-&gt;<span class="built_in">setConnectionCallback</span>(connectionCallback_);</span><br><span class="line">  conn-&gt;<span class="built_in">setMessageCallback</span>(messageCallback_);</span><br><span class="line">  conn-&gt;<span class="built_in">setWriteCompleteCallback</span>(writeCompleteCallback_);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¸‹é¢æ˜¯æ³¨å†ŒTcpServerçš„å›è°ƒå‡½æ•°</span></span><br><span class="line">  conn-&gt;<span class="built_in">setCloseCallback</span>(boost::<span class="built_in">bind</span>(&amp;TcpServer::removeConnection, <span class="keyword">this</span>, _1)); <span class="comment">// <span class="doctag">FIXME:</span> unsafe</span></span><br><span class="line">  <span class="comment">// è®©æ‰€å±çš„EvenLoopè°ƒç”¨connectEstablished</span></span><br><span class="line">  ioLoop-&gt;<span class="built_in">runInLoop</span>(boost::<span class="built_in">bind</span>(&amp;TcpConnection::connectEstablished, conn));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å’Œæˆ‘ä»¬çŒœæµ‹çš„æµç¨‹ä¸€æ ·ï¼Œè€Œå¯¹äºTcpConnectionè®¾ç½®çš„å›è°ƒï¼Œå…¶å®å°±æ˜¯ç”¨æˆ·æ‰€ä¼ å…¥çš„ï¼Œå½“ç„¶åœ¨TcpConnectionä¸­å†ç»§ç»­æŠŠå›è°ƒä¼ å…¥Channelæ—¶ï¼Œè¿˜æ˜¯ä¼šæœ‰ä¸€å±‚wrapçš„ï¼Œè¿™æ˜¯ä¸Šé¢æåˆ°çš„ã€‚</p>
<p>è¿™æ—¶å€™æˆ‘ä»¬å›è¿‡æ¥å…³æ³¨åˆšåˆšæ²¡æœ‰æåˆ°çš„<code>connectEstablished</code>ï¼Œè¿™ä¹Ÿæ˜¯ç†è§£muduoç”Ÿå‘½å‘¨æœŸçš„ä¸€ä¸ªå…³é”®ã€‚</p>
<h3><span id="connectestablished">connectEstablished</span></h3><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥æ¥çœ‹ä¸€ä¸‹ä¸€ä¸ªTcpConnectionçš„ç”Ÿå‘½å‘¨æœŸäº†</p>
<ul>
<li>åˆ›å»ºï¼š</li>
</ul>
<p>ç”±TcpServerä¼ å…¥Acceptorçš„å›è°ƒä¸­åˆ›å»ºï¼Œå¹¶æ”¾å…¥Mapå½“ä¸­</p>
<ul>
<li>é‡Šæ”¾ï¼š</li>
</ul>
<p>å½“ä¸€ä¸ªtcpè¿æ¥å…³é—­çš„æ—¶å€™ï¼Œé¦–å…ˆè§¦å‘Pollerçš„å¯è¯»äº‹ä»¶ï¼Œè°ƒç”¨Channel::handledEventæ¥å¤„ç†ï¼Œç„¶åè°ƒç”¨TcpConnection::handledreadå¤„ç†ï¼ŒhandledReadç»è¿‡readåå‘ç°è¿”å›å­—èŠ‚ä¸º0ï¼Œç»§ç»­è°ƒç”¨TcpCOnnecton::handledCloseï¼Œåœ¨è¿™é‡Œé¢ä¼šè°ƒç”¨tcpServeræ³¨å†Œçš„å›è°ƒå‡½æ•°removeConnectionï¼ŒTcpServer::removeConnectionä¼šå°†è¿™ä¸ªTcpConnectionä»å®ƒçš„è¿æ¥åˆ—è¡¨ä¸­åˆ é™¤ï¼Œä½†æ˜¯æ­¤æ—¶ä¸èƒ½ç›´æ¥delete TcpConnectionè¿™ä¸ªå¯¹è±¡ï¼Œå› ä¸ºTcpConnnectionå¯¹è±¡ä¸­çš„channelè¿˜åœ¨å‡½æ•°è°ƒç”¨æ ˆä¸­è°ƒç”¨handledEventï¼Œæ­¤æ—¶å¦‚æœç›´æ¥delete TcpConnectionï¼Œä¼šå°†channelä¹Ÿdeleteæ‰ï¼Œç¨‹åºä¼šå‡ºç°core dumpé”™è¯¯ï¼Œæ‰€ä»¥éœ€è¦ç­‰channel::handeledEventï¼Œæ‰§è¡Œå®Œæ¯•ä¹‹åå†delete TcpConnectionå¯¹è±¡ï¼Œè¿™å°±ç”¨åˆ°shared_ptrã€‚</p>
<p>æ‰€ä»¥ï¼Œè¿™æ—¶å€™æˆ‘ä»¬ä¹Ÿå¯ä»¥å›è¿‡å¤´æ¥çœ‹Channelä¸­çš„<code>tie</code>å’Œ<code>tied_</code>äº†ï¼Œå®ƒåœ¨<code>connectEstablished</code>ä¸­è¢«ç»‘å®šåˆ°è‡³å°‘å’ŒTcpConnectioçš„ç”Ÿå‘½å‘¨æœŸä¸€æ ·é•¿ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">TcpConnection::connectEstablished</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">setState</span>(kConnected);</span><br><span class="line">  channel_-&gt;<span class="built_in">tie</span>(<span class="built_in">shared_from_this</span>());</span><br><span class="line">  channel_-&gt;<span class="built_in">enableReading</span>();   </span><br><span class="line">  <span class="built_in">connectionCallback_</span>(<span class="built_in">shared_from_this</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“TCPè¿æ¥æ–­å¼€ï¼Œè¿™ä¸ªIOäº‹ä»¶ä¼šè§¦å‘<code>Channel::handleEvent()</code>å‡½æ•°ï¼Œè€Œåè€…å›è°ƒç”¨æˆ·æä¾›çš„<code>CloseCallbask</code>ï¼Œç”¨æˆ·ä»£ç å¯èƒ½å¯èƒ½ææ„Channelå¯¹è±¡ã€‚è¿™æ ·å°±ä¼šå¼•èµ·<code>Channel::handleEvent()</code>æ‰§è¡Œåˆ°ä¸€åŠæ—¶ï¼Œå…¶æ‰€å±çš„Channelè¢«é”€æ¯äº†ã€‚</p>
<h2><span id="buffer">Buffer</span></h2><p>è¿™ç¯‡çš„æœ€åä¸€ä¸ªå†…å®¹ï¼ŒBufferçš„è®¾è®¡éå¸¸ç®€æ´ï¼Œåªè¦ç†è§£äº†Bufferçš„ç»“æ„å°±å¯ä»¥å¾ˆå¥½çš„ç†è§£è¿™äº›æ¥å£ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// A buffer class modeled after org.jboss.netty.buffer.ChannelBuffer</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @code</span></span><br><span class="line"><span class="comment">/// +-------------------+------------------+------------------+</span></span><br><span class="line"><span class="comment">/// | prependable bytes |  readable bytes  |  writable bytes  |</span></span><br><span class="line"><span class="comment">/// |                   |     (CONTENT)    |                  |</span></span><br><span class="line"><span class="comment">/// +-------------------+------------------+------------------+</span></span><br><span class="line"><span class="comment">/// |                   |                  |                  |</span></span><br><span class="line"><span class="comment">/// 0      &lt;=      readerIndex   &lt;=   writerIndex    &lt;=     size</span></span><br><span class="line"><span class="comment">/// @endcode</span></span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­prependableçš„ä½œç”¨å°±æ˜¯<strong>è®©ç¨‹åºä»¥å¾ˆä½çš„ä»£ä»·åœ¨æ•°æ®å‰é¢æ·»åŠ å‡ ä¸ªå­—èŠ‚</strong>ã€‚æ¯”å¦‚ï¼Œç¨‹åºä»¥å›ºå®šçš„4ä¸ªå­—èŠ‚è¡¨ç¤ºæ¶ˆæ¯çš„é•¿åº¦æ¥å¯¹Tcpè¿›è¡Œåˆ†åŒ…ï¼Œå…¶å®ƒç»“æ„çš„å«ä¹‰åˆ™éå¸¸æ˜¾è€Œæ˜“è§ã€‚</p>
<h2><span id="æ€»ç»“">æ€»ç»“</span></h2><p>ç°åœ¨muduoçš„æ•´ä¸ªæµç¨‹å·²ç»éå¸¸æ¸…æ™°äº†ï¼Œæˆ‘ä»¬é€šè¿‡TcpServerè®¾ç½®ç›¸åº”äº‹ä»¶çš„å›è°ƒå‡½æ•°ï¼Œç„¶åTcpServeræŒæœ‰çš„Acceptoråˆ™ç”¨æ¥æ¥å—æ–°è¿æ¥ï¼Œå¹¶ä¸”å°†è‡ªå·±çš„Channelé€šè¿‡EventLoopæ³¨å†Œåˆ°Pollerä¸­ï¼Œè€ŒTcpServerä¼ ç»™Acceptorçš„å›è°ƒåœ¨æ¯æ¬¡æ¥å—æ–°è¿æ¥æ—¶éƒ½ä¼šè¢«è°ƒç”¨ï¼Œè€Œååˆ›å»ºä¸€ä¸ªTcpConnectionï¼ŒTcpConnectionåˆ™åˆ›å»ºä¸€ä¸ªChannelå¹¶ä¸”é€šè¿‡EventLoopè¿›è¡Œäº‹ä»¶æ³¨å†Œï¼Œå¦‚æœåœ¨å¤šçº¿ç¨‹ä¸‹ï¼Œæ¯æ¬¡åˆ›å»ºæ–°çš„TcpConnectionæ—¶ï¼Œéƒ½ä¼šåˆ†é…åˆ°å„è‡ªçš„EventLoopä¸­ã€‚æœ€åEventLoopåœ¨è‡ªèº«çš„<code>loop</code>ä¸­ä¸æ–­ç­‰å¾…äº‹ä»¶å’Œè°ƒç”¨Channelå¤„ç†äº‹ä»¶ä»¥åŠå¤„ç†<code>runInLoop</code>æ·»åŠ çš„ä»»åŠ¡ã€‚</p>
<p>ä¸‹ç¯‡æˆ‘ä»¬å¼€å§‹åˆ†æçº¿ç¨‹æ± ã€‚</p>

    </div>
    
    <div class="post__license">
        <p>
            <strong>Author: </strong>dejavudwh
        </p>
        <p>
            <strong>
                Permalink: 
            </strong>
            <a href="http://dejavudwh.cn/2022/05/08/muduo%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%9ATcpServer/">http://dejavudwh.cn/2022/05/08/muduo%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%9ATcpServer/</a>
        </p>
        
    </div>
 
    <div class="post-footer__meta"><p>updated at 2022-05-08</p></div> 
    <div class="post-entry__tags"><a href="/tags/muduo/" class="post-tags__link button"># muduo</a><a href="/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" class="post-tags__link button"># æºç è§£æ</a></div> 
</article>


    <div class="nav">
        <div class="nav__prev">
            
                <a href="/2022/05/08/muduo%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%9AEventLoopThreadPool/" class="nav__link">
                    <div>
                        <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="24" height="24"><path d="M589.088 790.624L310.464 512l278.624-278.624 45.248 45.248L400.96 512l233.376 233.376z" fill="#808080"></path></svg>
                    </div>
                    <div>
                        <div class="nav__label">
                            Previous Post
                        </div>
                        <div class="nav__title">
                            muduoæºç è§£æï¼šEventLoopThreadPool
                        </div>
                    </div>
                </a>
            
        </div>
        <div class="nav__next">
            
                <a href="/2022/05/07/muduo%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%9AEventLoop/" class="nav__link">
                    <div>
                        <div class="nav__label">
                            Next Post
                        </div>
                        <div class="nav__title">
                            muduoæºç è§£æï¼šEventLoop
                        </div>
                    </div>
                    <div>
                        <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="24" height="24"><path d="M434.944 790.624l-45.248-45.248L623.04 512l-233.376-233.376 45.248-45.248L713.568 512z" fill="#808080"></path></svg>
                    </div>
                </a>
            
        </div>
    </div>





</main>

            <footer class="footer">
     
    <a href="#" class="button" id="b2t" aria-label="Back to Top" title="Back to Top">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" width="32" height="32">
            <path d="M233.376 722.752L278.624 768 512 534.624 745.376 768l45.248-45.248L512 444.128zM192 352h640V288H192z" fill="currentColor"></path>
        </svg>
    </a>

    


    
     
 

 
    
        
        <p class="footer-copyright">
            Copyright Â© 2022 <a href="/">dejavudwh&#39;s blog</a>
        </p>
    
    
    <p>Powered by <a href="https://hexo.io" target="_blank">Hexo</a> | Theme - <a href="https://github.com/ChrAlpha/hexo-theme-cards" target="_blank">Cards</a></p>
</footer>

        </div>
        
    <script defer src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.1.0/dist/lazyload.min.js"></script>
    <script>
        window.lazyLoadOptions = {
            elements_selector: ".lazy",
            threshold: 0
        };
    </script>
 

 

 

 
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement('script');
            hm.src = 'https://hm.baidu.com/hm.js?c6efdb1ec90601ee8e2211b3651001bc';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
 

 



 



 


    
 


    
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>

    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.4.1/dist/jquery.fancybox.min.css">

    
<script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.4.1/dist/jquery.fancybox.min.js"></script>

    <script>
        let lazyloadT = Boolean('true'),
            auto_fancybox = Boolean('false')
        if (auto_fancybox) {
            $(".post__content").find('img').each(function () {
                var element = document.createElement("a");
                $(element).attr("data-fancybox", "gallery");
                $(element).attr("href", $(this).attr("src"));
                if (lazyloadT) {
                    $(element).attr("href", $(this).attr("data-srcset"));
                }
                $(this).wrap(element);
            });
        } else {
            $(".post__content").find("fancybox").find('img').each(function () {
                var element = document.createElement("a");
                $(element).attr("data-fancybox", "gallery");
                $(element).attr("href", $(this).attr("src"));
                if (lazyloadT) {
                    $(element).attr("href", $(this).attr("data-srcset"));
                }
                $(this).wrap(element);
            });
        }
    </script>
 

 

 

 

 




    </body>
</html>
